{% load static %}
<!-- Django template tag‚Äôleri kullanacaksan (static dosya vs) y√ºklenir.
     Bu sayfada static kullanƒ±lmƒ±yor ama dursun, sorun deƒüil. -->

<!DOCTYPE html>
<html lang="tr">
<head>
    <!-- T√ºrk√ße karakterleri doƒüru g√∂stermek i√ßin -->
    <meta charset="utf-8" />

    <!-- Sekmede g√∂r√ºnen ba≈ülƒ±k -->
    <title>≈ûirket Uyum Detayƒ± (SPA)</title>

    <!-- Responsive (mobil uyum) -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
</head>

<body class="bg-light">

<div class="container py-4">
    <!-- √úst bar: geri link + ba≈ülƒ±k + ≈üirket adƒ± -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <!-- SPA ≈üirket listesine geri d√∂n -->
            <a href="/api/companies-spa/" class="text-decoration-none small">
                ‚Üê ≈ûirket listesine d√∂n
            </a>

            <!-- Sayfa ba≈ülƒ±ƒüƒ± -->
            <h1 class="h3 mt-2 mb-0">≈ûirket Uyum Detayƒ± (SPA)</h1>

            <!-- Django template: ≈üirket adƒ± server-side basƒ±lƒ±yor -->
            <p class="text-muted mb-0">{{ company_name }}</p>
        </div>
    </div>

    <!-- React‚Äôin render edeceƒüi ‚Äúmount point‚Äù.
         Django burada sadece company_id basƒ±yor -->
    <div id="app"
         data-company-id="{{ company_id }}">
    </div>
</div>

<!-- React / ReactDOM‚Äôu CDN ile √ßekiyoruz -->
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

<script>
    // React.createElement‚Äôi kƒ±sa kullanmak i√ßin
    const e = React.createElement;

    // ---------------------------
    // CSRF helper (Django SessionAuth i√ßin)
    // ---------------------------
    // Django‚Äôda PATCH/POST/PUT gibi isteklerde CSRF token gerekebilir.
    // Cookie‚Äôden csrftoken‚Äôi okuyup header‚Äôa basƒ±yoruz.
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
        return null;
    }

    function DetailApp() {
        // #app elementini al
        const rootEl = document.getElementById("app");

        // data-company-id‚Äôyi integer‚Äôa √ßevir
        const companyId = parseInt(rootEl.dataset.companyId, 10);

        // ---------------------------
        // State‚Äôler
        // ---------------------------
        // API‚Äôden gelen t√ºm dashboard verisini tutar
        const [data, setData] = React.useState(null);

        // ilk y√ºkleme sƒ±rasƒ±nda ‚ÄúY√ºkleniyor‚Ä¶‚Äù g√∂stermek i√ßin
        const [loading, setLoading] = React.useState(true);

        // hata mesajƒ± state‚Äôi
        const [error, setError] = React.useState(null);

        // PATCH atarken butonlarƒ± kilitlemek i√ßin
        const [saving, setSaving] = React.useState(false);

        // ---------------------------
        // Dashboard verisini √ßek
        // ---------------------------
        const loadDashboard = React.useCallback(() => {
            setLoading(true);
            setError(null);

            // Dƒ∞KKAT:
            // Burada endpoint /api/companies/<id>/dashboard/
            // (yani senin DRF dashboard endpoint‚Äôin)
            fetch(`/api/companies/${companyId}/dashboard/`)
                .then((res) => {
                    if (!res.ok) {
                        throw new Error("Dashboard API hata: " + res.status);
                    }
                    return res.json();
                })
                .then((json) => {
                    // Gelen JSON‚Äôu state‚Äôe yaz
                    setData(json);
                    setLoading(false);
                })
                .catch((err) => {
                    // Hata varsa yazdƒ±r
                    setError(err.message);
                    setLoading(false);
                });
        }, [companyId]); // companyId deƒüi≈üirse callback g√ºncellenir

        // Component ilk a√ßƒ±lƒ±nca dashboard‚Äôu 1 kez √ßek
        React.useEffect(() => {
            loadDashboard();
        }, [loadDashboard]);

        // ---------------------------
        // Obligation TAMAMLA / GERƒ∞ AL (PATCH)
        // ---------------------------
        const handleToggleObligation = (obligationId, nextStatus) => {
            setSaving(true);
            setError(null);

            // status endpoint‚Äôine PATCH atƒ±yoruz:
            // body: { is_compliant: true/false }
            fetch(`/api/obligations/${obligationId}/status/`, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                    // Django CSRF (cookie‚Äôden okunur)
                    "X-CSRFToken": getCookie("csrftoken") || "",
                },
                body: JSON.stringify({ is_compliant: nextStatus }),
            })
                .then((res) => {
                    if (!res.ok) {
                        throw new Error("Status API hata: " + res.status);
                    }
                    return res.json();
                })
                .then((json) => {
                    // PATCH cevabƒ±nƒ± mevcut data ile birle≈ütiriyoruz.
                    // Senin obligation_status_api cevabƒ±n genelde:
                    // { compliance_score, stats, todo, completed, obligation: {...} }
                    // Dashboard‚Äôdaki ‚Äúsirket‚Äù bilgisi patch response‚Äôta yoksa prev‚Äôden koruyoruz.
                    setData((prev) => ({
                        ...(prev || {}),
                        ...json,
                        sirket: json.sirket || json.company || (prev && (prev.sirket || prev.company)),
                    }));
                    setSaving(false);
                })
                .catch((err) => {
                    setError(err.message);
                    setSaving(false);
                });
        };

        // ---------------------------
        // Render: Loading / Error / Bo≈ü veri
        // ---------------------------
        if (loading) {
            return e("div", { className: "alert alert-info" }, "Y√ºkleniyor...");
        }
        if (error) {
            return e("div", { className: "alert alert-danger" }, "Hata: " + error);
        }
        if (!data) {
            return e("div", null, "Veri bulunamadƒ±.");
        }

        // ---------------------------
        // JSON alanlarƒ±nƒ± normalize et
        // ---------------------------
        // Dashboard endpoint‚Äôin: data.sirket i√ßinde ≈üirket detaylarƒ±nƒ± veriyor
        const sirket = data.sirket || data.company || {};

        // Skor i√ßin farklƒ± isim ihtimallerine kar≈üƒ± fallback zinciri:
        // - PATCH response: compliance_score
        // - Dashboard response: uyum_skoru
        // - ≈üirket objesi i√ßinde compliance_score (varsa)
        const score =
            data.compliance_score ??
            data.uyum_skoru ??
            (sirket && sirket.compliance_score) ??
            "-";

        // ƒ∞statistikler + listeler
        const stats = data.stats || {};
        const todo = data.todo || [];
        const completed = data.completed || [];

        // ---------------------------
        // UI render (Bootstrap kartlar + list-group)
        // ---------------------------
        return e(
            "div",
            null,

            // saving true ise uyarƒ± g√∂ster
            saving &&
                e(
                    "div",
                    { className: "alert alert-warning py-2 small" },
                    "Deƒüi≈üiklikler kaydediliyor..."
                ),

            // √úst: skor + ≈üirket √∂zeti (2 kolon)
            e(
                "div",
                { className: "row mb-4" },

                // Sol: skor kartƒ±
                e(
                    "div",
                    { className: "col-md-4 mb-3" },
                    e(
                        "div",
                        { className: "card text-center h-100" },
                        e("div", { className: "card-header" }, "Uyum Skoru"),
                        e(
                            "div",
                            { className: "card-body" },
                            e(
                                "div",
                                { style: { fontSize: "3rem", fontWeight: "bold" } },
                                score + "/100"
                            )
                        )
                    )
                ),

                // Saƒü: ≈üirket √∂zeti kartƒ±
                e(
                    "div",
                    { className: "col-md-8 mb-3" },
                    e(
                        "div",
                        { className: "card h-100" },
                        e("div", { className: "card-header" }, "≈ûirket √ñzeti"),
                        e(
                            "div",
                            { className: "card-body" },
                            e("p", null, e("strong", null, "Ad: "), sirket.name || "-"),
                            e("p", null, e("strong", null, "Sekt√∂r: "), sirket.sector || "-"),
                            e(
                                "p",
                                null,
                                e("strong", null, "√áalƒ±≈üan sayƒ±sƒ±: "),
                                sirket.employee_count ?? "-"
                            ),
                            e(
                                "p",
                                null,
                                e("strong", null, "Lokasyon: "),
                                sirket.location_city || "-"
                            ),
                            e(
                                "p",
                                null,
                                e("strong", null, "ƒ∞hracat√ßƒ± mƒ±?: "),
                                sirket.is_exporter ? "Evet" : "Hayƒ±r"
                            )
                        )
                    )
                )
            ),

            // ƒ∞statistik kartlarƒ± (3 kolon)
            e(
                "div",
                { className: "row mb-4" },

                e(
                    "div",
                    { className: "col-md-4 mb-3" },
                    e(
                        "div",
                        { className: "card text-center h-100" },
                        e("div", { className: "card-header" }, "Toplam Y√ºk√ºml√ºl√ºk"),
                        e("div", { className: "card-body h4" }, stats.total_obligations ?? 0)
                    )
                ),

                e(
                    "div",
                    { className: "col-md-4 mb-3" },
                    e(
                        "div",
                        { className: "card text-center h-100" },
                        e("div", { className: "card-header" }, "A√ßƒ±k Y√ºk√ºml√ºl√ºk"),
                        e("div", { className: "card-body h4" }, stats.open_obligations ?? 0)
                    )
                ),

                e(
                    "div",
                    { className: "col-md-4 mb-3" },
                    e(
                        "div",
                        { className: "card text-center h-100" },
                        e("div", { className: "card-header" }, "Gecikmi≈ü Y√ºk√ºml√ºl√ºk"),
                        e("div", { className: "card-body h4" }, stats.overdue_obligations ?? 0)
                    )
                )
            ),

            // A√ßƒ±k y√ºk√ºml√ºl√ºkler (TODO)
            e("h4", { className: "mb-3" }, "A√ßƒ±k Y√ºk√ºml√ºl√ºkler"),
            todo.length === 0
                ? e("p", { className: "text-muted" }, "A√ßƒ±k y√ºk√ºml√ºl√ºk yok üéâ")
                : e(
                      "div",
                      { className: "list-group mb-4" },
                      todo.map((obl) =>
                          e(
                              "div",
                              {
                                  key: obl.obligation_id,
                                  className:
                                      "list-group-item d-flex justify-content-between align-items-start",
                              },
                              // Sol bilgi kƒ±smƒ±
                              e(
                                  "div",
                                  { className: "me-3" },
                                  e(
                                      "div",
                                      { className: "fw-semibold" },
                                      obl.regulation_title || "Y√ºk√ºml√ºl√ºk"
                                  ),
                                  e(
                                      "div",
                                      { className: "small text-muted" },
                                      "Son tarih: " + (obl.due_date || "-")
                                  ),
                                  e(
                                      "div",
                                      { className: "small text-muted" },
                                      "Etki: " +
                                          (obl.impact_type || "-") +
                                          " ¬∑ Risk: " +
                                          (obl.risk_level || "-")
                                  )
                              ),
                              // Saƒü buton kƒ±smƒ±
                              e(
                                  "div",
                                  { className: "text-nowrap" },
                                  e(
                                      "button",
                                      {
                                          type: "button",
                                          className: "btn btn-sm btn-success",
                                          disabled: saving, // PATCH atarken kilitle
                                          onClick: () =>
                                              handleToggleObligation(obl.obligation_id, true),
                                      },
                                      "Tamamlandƒ±"
                                  )
                              )
                          )
                      )
                  ),

            // Tamamlananlar
            e("h5", { className: "mt-4 mb-3" }, "Tamamlanan Y√ºk√ºml√ºl√ºkler"),
            completed.length === 0
                ? e("p", { className: "text-muted" }, "Hen√ºz tamamlanan y√ºk√ºml√ºl√ºk yok.")
                : e(
                      "div",
                      { className: "list-group mb-4" },
                      completed.map((obl) =>
                          e(
                              "div",
                              {
                                  key: obl.obligation_id,
                                  className:
                                      "list-group-item d-flex justify-content-between align-items-start",
                              },
                              // Sol bilgi kƒ±smƒ±
                              e(
                                  "div",
                                  { className: "me-3" },
                                  e(
                                      "div",
                                      { className: "fw-semibold" },
                                      obl.regulation_title || "Y√ºk√ºml√ºl√ºk"
                                  ),
                                  e(
                                      "div",
                                      { className: "small text-muted" },
                                      "Etki: " +
                                          (obl.impact_type || "-") +
                                          " ¬∑ Risk: " +
                                          (obl.risk_level || "-")
                                  )
                              ),
                              // Saƒü buton: geri al
                              e(
                                  "div",
                                  { className: "text-nowrap" },
                                  e(
                                      "button",
                                      {
                                          type: "button",
                                          className: "btn btn-sm btn-outline-secondary",
                                          disabled: saving,
                                          onClick: () =>
                                              handleToggleObligation(obl.obligation_id, false),
                                      },
                                      "Geri al"
                                  )
                              )
                          )
                      )
                  )
        );
    }

    // React 18 root olu≈ütur ve component‚Äôi render et
    const root = ReactDOM.createRoot(document.getElementById("app"));
    root.render(e(DetailApp));
</script>

</body>
</html>
